
<html>
<head>
<title>ee576 Lab 3</title>
</head>

<body>
<h2>
EE 576: Laboratory 3 </h2> 
<h2> NiosII with &mu;C/OS audio generator. </h2>
<p>
<b> Introduction. </b>

<p> In this assignment you will implement a audio interface to the NiosII processor. You will use the <a href="../../../../../../altera.com/education/univ/materials/manual/labs/tut_sopc_introduction_verilog.pdf">SOPC builder</a> to construct a NiosII processor, QuartusII to add an audio interface, and the NiosII IDE to write a GCC/microC/OS program to control an audio generator. 
<p> <b> Procedures:</b>  
<ol>
  <li>  You must handle the boards only on on the ESD mat. These boards are expensive and you must be careful of them. 
  <li>Make sure the Altera DE2 board is connected to power and to the PC as specified 
    in the evaluation board description. Turn on the power supply with the red switch 
    on the board. Make sure the toggle switch on the left edge of the board marked (<code>Run/Prog</code>) is in the <code>Run</code> position and <em>leave it there at all times</em>.
The FPGA will program in the <code>Run</code> position. Putting the switch in the <code>Prog</code> position writes your design to flash memory, which you do not want to do.
  <li>The <a href="../../DE2/DE2_TOP.v">default top level module</a> for the DE2 defines all of the logical i/o signals. 
  <li>You can define the mapping from logical signal to FPGA pins (<em>pin assignment</em> in QuartusII) for all the pins at once by importing <a href="../../DE2/DE2_pin_assignments.csv">this file</a> using the menu item <code>Assignments... Import Assignments...</code> and specifying the file name. There is no need to define pins one-by-one.  
<li>You will need to read the Audio Codec <a href="../../DE2_Datasheets/Audio%20CODEC/WM8731_WM8731L.pdf">datasheet</a>. See also example 4 on the <a href="../../../../../../instruct1.cit.cornell.edu/courses/ece576/DE2/index.html">DE2 hardware examples</a> page. 
</ol>
<p><strong>--Setting up a demo <a href="../../../../../../instruct1.cit.cornell.edu/courses/ece576/NiosII_muCOS/index.html">&mu;C/OS</a> project in QuartusII and the NiosII IDE:</strong></p>
<ol>
  <li>Download the top-level module <code><a href="../../../../../../instruct1.cit.cornell.edu/courses/ece576/NiosII_muCOS/TestBigNios.v">TestBigNios.v</a></code> from the <a href="../../../../../../instruct1.cit.cornell.edu/courses/ece576/NiosII_muCOS/index.html">&mu;C/OS page</a>, example #1.</li>
  <li>Copy the file <code>sdram_pll.v</code> and <code>sdram_pll_bb.v</code> from one of the zipped SDRAM examples, or generate a new PLL module as described in the <a href="../../../../../../www.altera.com/education/univ/materials/manual/labs/tut_DE2_sdram_verilog.pdf">SDRAM tutorial</a>. If you find that memory cannot be loaded in step 14 below, then run the <code>Megawizard Plugin Manager</code> in the <code>Tools...</code> menu, choose edit, choose the <code>sdram_pll.v</code> file, then click through to the <code>Finish</code>, taking all the default options. This will regenerate any missing files. </li>
  <li> Start quartusII
    <ol>
      <li>choose menu File/ New project wizard </li>
      <li>change working dir to <code>Z:\ece576\OStest</code> (or whatever you choose, BUT with no spaces in the path)</li>
      <li>set top level design entity to <code>TestBigNios</code> </li>
      <li>click next </li>
      <li>click <code>add all</code> in design file dialog </li>
      <li>click next </li>
      <li>click finish</li>
    </ol>
  </li>
  <li>Back in the main QuartusII interface, open TestBigNios.v</li>
  <li>Open SOPC builder:
    <ol>
      <li>set system name to <code>bigNios</code> </li>
      <li>add standard NiosII (S) </li>
      <li>add (<strong>in this order</strong>, and with these names)
        <ol>
          <li>sdram (settings 16-1-4-12-8) </li>
          <li>lcd</li>
          <li>jtag_uart</li>
          <li>Out0 (32-bit output port)</li>
          <li>Out1 (32-bit output port)</li>
          <li>In0  (32-bit input port)</li>
          <li>In1_8bit  (8-bit input port)</li>
          <li>timer_0</li>
        </ol>
      </li>
      <li>Generate the system </li>
      <li><strong>Close</strong> SOPC builder (every time you open SOPC builder, the NiosII IDE has to rebuild syslib) </li>
    </ol>
  </li>
  <li>Back in the main QuartusII interface: 
    <ol>
      <li> Import the pin assignments file</li>
      <li>Make sure that the order of parameters generated by SOPC builder matches the order in the top-level module.</li>
      <li>Synthesize the Verilog in QuartusII </li>
      <li>Download the .sof file to the FPGA </li>
    </ol>
  </li>
  <li>When using the IDE there must be <strong>no space characters in the path</strong> you choose to your workspace! </li>
  <li>Start the IDE</li>
  <li>Specify a workspace. When you designed the cpu and top-level module, the design was stored in a folder. In the Workspace selection dialog box, browse for that folder, then add the string <code>\software</code> to the folder path. This new folder will be used to store all of the software projects associated with the specific cpu you built in the SOPC. After you press OK, you may need to click on the <code>workbench</code> icon to do anything useful. </li>
  <li>Create a new software project. Select <code>File&gt;New&gt;project</code>. A series of dialog boxes will open.
      <ol>
        <li>Choose <code>C/C++</code> application, then click <code>Next</code>. </li>
        <li>Give the project a <code>name</code>, specify the <code>ptf</code> file from SOPC builder, use the <code>default location</code>, and specify a <code>blank project</code>. <br>
        Then click <code>Next</code>.</li>
        <li>Select <code>creat new system library</code> then click <code>finish</code>. </li>
      </ol>
  </li>
  <li>Back in the main IDE window, right-click on the <code>syslib</code> entry in the <code>C/C++ Projects </code>pane, then select <code>Properties</code>.
      <ol>
        <li>In the dialog box, select <code>system library</code> on the left. </li>
        <li>Associate the desired device with <code>stdout</code>, <code>stdin</code>, and <code>stderr</code>. These will usually default to the JTAG UART. </li>
        <li>From the pulldown menu, select <code>microC/OS</code>. Note that the web-version of the IDE does not support the operating system. </li>
        <li>Select the memory location, usually defaults to SDRAM. </li>
        <li>Make sure that the check box options are appropriate. Unselect the <code>simulation only</code> box. </li>
        <li>Click <code>OK</code> to proceed. </li>
      </ol>
  </li>
  <li>Back in the main IDE window, right-click on the <code>syslib</code> entry in the <code>C/C++ Projects </code>pane, then select <code>Build Project</code>. <br>
    Wait for it to finish. </li>
  <li>Create a newC file using<code> File&gt;New&gt;file </code>then and paste the contents of the demo program<code> <a href="../../../../../../instruct1.cit.cornell.edu/courses/ece576/NiosII_muCOS/test1_ucosii.c">test1_mucosII.c</a> </code>into the new file. In the <code>Nios II C/C++ Project</code> pane, the project (not the syslib) <em>should be highlighted before creating</em> the new c file.</li>
  <li>In <code>Run...</code> menu item be sure that the download option points to the actual project (not the syslib project).
    
In the Run... dialog double-click the NiosII hardware option to find
the USB-blaster device and download to the software to the NiosII</li>
  <li>After the program loads, you should see scrolling text in the IDE console  area
  </li>
</ol>
<p>Another example, the third project ( &mu;C/OS with ISR) on the  &mu;C/OS page is <a href="../../NiosII_muCOS/microCOS/MicroCOSwithISR.zip">zipped here</a>. </p>
<hr>
<b> Assignment </b> 
<ul>
  <li> You will design a cpu system, plus timers, UARTs and parallel interfaces in SOPC, then use Verilog to add the audio codec hardware interface. Don't use schematic entry or VHDL.</li>
  <li>You will use microC/OS to construct three tasks to:
    <ul>
      <li>Handle the JTAG-UART and set parameters from the human user using the NiosII IDE console area.</li>
      <li>Display the waveform type and frequency on the LCD. </li>
      <li>
	  Communicate with the Audio Codec and synthesis hardware to produce the appropriate waveform.
    </ul>
  </li>
  <li>The audio generator should take a serial command to produce sine, square, triangle,  white noise, or ( <a href="../../../../../../www.music.mcgill.ca/~amburns/physique/basic.html">Karplus-Strong</a> string--optional ) </li>
  <li>Sine, square, or triangle waveforms should be produced by hardware (not in a cpu) <a href="../../../../../../www.geocities.com/CapeCanaveral/5611/dds.html">Direct Digital Synthesis</a>. </li>
  <li>The Karplus-Strong string sound should be produced in hardware. The string pluck should occur when a button is pushed.</li>
  <li>The audio generator should take a serial command to set the frequency if the wavefrom is sine, square, triangle, or string. The freqeucy should be settable to within 1 Hz for sine, square, triangle over a range of 1 Hz to 10 kHz. The string sound should be settable to within 1% over a range of fundamental of 50 Hz to 500 Hz.. </li>
  <li>The audio generator should take a serial command to set the cutoff frequency of the white noise with a normalized frequency range of .05 to 0.5. </li>
  <li>White noise should be produced by using a hardware (not in a cpu) <a href="../../../../../../en.wikipedia.org/wiki/Linear_feedback_shift_register">xor-feedback shift register</a> or <a href="../../../../../../en.wikipedia.org/wiki/Linear_congruential_generator">Linear Congruential Generator</a> followed by a first order hardware digital low pass filter.</li>
</ul>
<p>

Be prepared to demo your design to your TA in lab.
        
    
<p> Your written lab report should include: 
<ul>
  <li>A  explaination of the audio codec commands   
  <li>How you implemented the random number, DDS, and Karplus-Strong circuits. 
  <li> A heavily commented listing of your Verilog design and GCC with microC/OS code. 
</ul>
<hr>
<small> <font size="-1">Copyright Cornell University May 2007</font></small> 
</body> </html>

