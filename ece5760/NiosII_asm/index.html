<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<title>NiosII assembler on DE2</title>
</head>

<body>
 <h2>NiosII assembler examples on DE2
</h2>
 <p>I used these examples to start teaching myself NiosII design. They are in the order I did them, rather than in a pedagogical order. There are many interesting tradoffs between hardware and software to be explored. </p>
 <ol type="1"><li>
   <p><strong>Using a hardware timer</strong>. <br>
     Each specific NiosII processor has different characteristics, so when talking about an assembler program, you also have to specifiy the specific NiosII that it runs on. I generated a basic economy cpu (<strong>E</strong> type) with two 8-bit parallel ports and a timer. The configuration is shown below. It is very similar to the DE2 SOPC tutorial version. To write assembler code, you need to notice the i/o addresses for each port and for the timer. Notice also that the timer uses IRQ 1 which means that we need to set bit 1 in control register 3 to enable a timer interrupt. By double-clicking on the memory tab you can check the amount of memory created. This is useful for positioning a stack at the top of memory. In this case I generated 4k of memory. <br>
      <img src="timer_SOPCconfig.png" width="815" height="281"><br>
      If you open the <code>More cpu options</code> tab, you can get the memory location that the interrupt unit uses for exception code. In this case it is <code>0x0000020</code>, which is the default.<br>
      <img src="timer_SPOCmoreCPU.png" width="495" height="166"><br>
      The SOPC produces some verilog files which need to be combined with a top-level module and <a href="DE2_pin_assignments.csv">FPGA pin definitions</a> using QuartusII. The <a href="TimerTest.v">top-level module</a> in this case is very simple, but could contain arbitrary circuitry (see #2 below).
    </p>
   <pre>// Implements a simple Nios II system for the DE2 board.
// Inputs: SW7-0 are parallel port inputs to the Nios II system
// CLOCK_50 is the system clock
// KEY0 is the active-low system reset
// Outputs: LEDG7-0 are parallel port outputs from the Nios II system
module TimerTest(SW, KEY, CLOCK_50, LEDG);
    input [7:0] SW;
    input [0:0] KEY;
    input CLOCK_50;
    output [7:0] LEDG;
    // Instantiate the Nios II system module generated by the SOPC Builder:
    // nios_system (clk, reset_n, out_port_from_the_LEDs, in_port_to_the_Switches)
    NiosII niosIItimer(CLOCK_50, KEY[0], LEDG, SW);
endmodule</pre>
   <p>The output of the QuartusII compilation is an <strong><code><a href="TimerTest_time_limited.sof">.sof</a></code></strong> file to be downloaded to the DE2 Using QuartusII, and a <strong><code><a href="NiosII.ptf">.ptf</a> </code></strong>file to be used by the NiosII debug client. The <code>ptf</code> file describes the custom cpu to the debugger client. At this point we have built the hardware. Now we need a program to run on it. A simple <a href="lightsV2.s">assembler program</a> transfers the position of 8 switches to 8 LEDs, and once a second inverts the LEDs. The timing is done using the hardware timer module described in the SOPC builder.  There are several things to notice in the code:</p>
   <ul><li>The 16-bit timer control registers (described in <a href="../../../../../altera.com/literature/hb/nios2/n2cpu_nii51008.pdf">Timer Core with Avalon Interface</a>) are spaced 32 bits apart in memory address starting at the address given by the SOPC builder table.</li>
     <li>The timer interrupt flag (<code>TO</code>) has to be cleared manually in the ISR. </li>
     <li>There are 3 levels of interrupt control on the NiosII. There is a master interrupt enable (<code>PIE</code>) in the cpu <code>status</code> register (control register 0). There are 32 individual interrupt enable bits for each different interrupt in the <code>ienable</code> control register. There is an interrupt enable on the specific hardware, in this case the timer <code>ITO</code> bit. </li>
     <li>Seven NOPs have to be inserted between the reset entry point (<code>0x00</code>) and the exception entry (<code>0x20</code>). The exception entry is located at <code>0x20</code> in order to put it on the second cache line (if there is a cache). </li>
     <li>The exception return register (<code>r29</code>) must be decremented by 4 before issuing the return-from-exception (<code>eret</code>), <em>only if</em> the exception is an interrupt (but not if it a software trap). See the <a href="../../../../../altera.com/literature/hb/nios2/n2cpu_nii5v1.pdf">NiosII Processor Reference Handbook</a>. </li>
     <li>Branches and jumps do not have a branch delay slot. See the <a href="../../../../../altera.com/literature/hb/nios2/n2cpu_nii5v1.pdf">NiosII Processor Reference Handbook</a>. </li>
     <li>A stack and <code>push</code> and <code>pop</code> macros were defined to make interrupt handling more general. You <em>must</em> set up the stack if you use <code>push</code> or <code>pop</code>. An general interrupt handler should check for multiple interrupt sources and prioritize them. </li>
   </ul>  
 </li> 
 <br>
   <li><strong>Modified support hardware</strong>. <br>
     Using the same NiosII processor and the same assembly program as in #1, the <a href="TimerTest_1.v">top-level verilog module</a> was changed to support 7-segment readout of the switch values and the blinking green LEDs. The switch setting are displayed on the left-most two digits, while the green LED value is displayed on HEX5:4 One short module was added along with the circuitry to drive the four  7-segment digits. An image below shows the right-most two switches in the up position. A short <a href="Timertest1.MPG">mpeg</a> shows the blink rate. <br>
   <a href="TimerTest_1.jpg"><img src="TimerTest_1small.jpg" width="350" height="274" border="2"></a> </li>
   <br>
   <li><strong>Minimum Clock Period with E (economy) cpu</strong>. <br>
     Modifying the <a href="TimerTest_2.v">top-level hardware again</a> to include a bit toggling  on the parallel i/o connector allows us to measure the timer frequency on an oscilloscope. Setting the hardware timer period to <code>0x00010000</code> should produce a frequency of <code>clk/period/2</code> or <code>5e6/2^16/2=381.5</code> Hz. The division by 2 is because two periods is equal to one cycle when the output is toggled on each period. My scope shows 381.4 Hz, which is within the accuracy of the scope itself. Setting the period to <code>0x00000100</code> should produce 97. 66 kHz and actually produces 98.0 kHz, as close as I can read. However there is about 0.6 microseconds of jitter in the period. Reducing the period to the minimum which will work, <code>0x00000070</code>, suggests that the interrupt service routine (plus entry overhead) takes about 110 cycles to complete. If you open the SOPC with this design, you will find that I used the low-performance NiosII cpu (e version), which is multicycle. The image below shows the trace with a period of <code>0x00000100</code>. <br>
   <img src="Timer0xff.jpg" width="400" height="299"> </li>
   <br>
   <li><strong>Faster NiosII cpu</strong>. <br>
     The cpu was changed to the <strong>S</strong> (pipelined version) with instruction cache, but runs the same code as above. Now the timing jitter is about 0.1 microseconds, but varies from 0.0 to 0.18 microseconds. A timer period of <code>0x0030</code> gives a frequency of 515 kHz against the calculated 521 kHz. The timer is  accurate to at least 4 places (the limit of my scope) at lower frequencies. The minimum relable timer period is about  32 cpu cycles. The timer ISR has 10 instructions <code>(movia, push</code>, and <code>pop</code> are two-instruction macros). It probably takes two or three cycles to get in and out of the ISR (storing <code>ea</code>, <code>status</code>, etc), so I am guessing about 2 cycles/instruction. This is consistent with Altera performance numbers. <br>
     <img src="timer_SOPCconfig2niosIIs.png" width="598" height="286">     <br>
   <img src="timer_SOPCconfig2.png">   </li>
   The <strong><code><a href="TimerTest_time_limited_2.sof">.sof</a></code></strong> file to be downloaded to the DE2 Using QuartusII, and a <strong><code><a href="NiosII_2.ptf">.ptf</a> </code></strong>file to be loaded into the Debug Client.<br>
 </ol>
   
   <hr>
   <p><strong>References
</strong></p>
   <p>JO Hamblen, TS Hall and MD Furman, <em>Rapid protoyping of digital systems</em>, Springer 2005 </p>
   <p><a href="../../../../../tigcc.ticalc.org/doc/gnuasm.html">GNU assembler manual</a> </p>
   <p>Altera <a href="../../../../../altera.com/literature/hb/nios2/n2cpu_nii51017.pdf">NiosII instruction set reference</a> </p>
   <p>Altera <a href="../../../../../altera.com/literature/hb/nios2/n2sw_nii52006.pdf">NiosII exception handling</a> </p>
   <hr>
   <p>Copyright Cornell University June 2006 </p>
   <p>&nbsp;</p>
</body>
</html>
