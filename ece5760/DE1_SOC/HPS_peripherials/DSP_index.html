<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>DSP</title>
</head>

<body>
<h2 align="center">Digital Signal Processing<br />
  DE1-SoC  <br />
  Cornell ece5760<br />
</h2>
<ul>
</ul>
<h3>Audio Digital Signal Processing</h3>
<p>There are 87 DSP blocks on <a href="../CycloneV_SE_A5.PNG">our FPGA</a>. Each one can be used in a <a href="../DSP_wp-01159-arriav-cyclonev-dsp.pdf">number of ways</a>.</p>
<p>-- <strong>Audio loop-back configuration</strong><br />
The <a href="../Audio_core.pdf">University Audio Core</a> supports audio input and output at various rates and resolutions, and exposes the data on the Avalon bus. The <a href="Bus_master_slave_index.html">Bus Master</a> page explains the basic connections. There is a control word, four 8-bit FIFO fields (in/out, left/right), and  left/right data registers. The lef/right data registers are read/write. Properly configured, a read to the data register gives data from the audio ADC, while the write to the data register outputs to the audio DAC. The <a href="../DSP/Audio/Audio_config.PNG">Audio Configuration module</a> needs to be modified in Qsys for proper operation. Double-click the module name in Qsys to open a dialog box. In the dialog box, set up: (1) Audio in Path: <span style="font-family: Consolas, 'Andale Mono', 'Lucida Console', 'Lucida Sans Typewriter', Monaco, 'Courier New', monospace">Line In to ADC</span>; (2)  Check <span style="font-family: Consolas, 'Andale Mono', 'Lucida Console', 'Lucida Sans Typewriter', Monaco, 'Courier New', monospace">Audio Out-Enable DAC Output</span>; (3) Uncheck <span style="font-family: Consolas, 'Andale Mono', 'Lucida Console', 'Lucida Sans Typewriter', Monaco, 'Courier New', monospace">Audio Out-Microphone Bypass</span>; (4) Uncheck <span style="font-family: Consolas, 'Andale Mono', 'Lucida Console', 'Lucida Sans Typewriter', Monaco, 'Courier New', monospace">Audio Out-Line In Bypass </span><br />
Generate the <a href="../DSP/Audio/audio_loopback/qsys_layout.PNG">Qsys design</a>, and recompile the project. This project just loops the audio input to the audio output, except that if you turn switch zero on, a tone is generated on the left channel with a frequency proportional to all the switch settings. You have to press reset (button zero) after you load the design to start the state machine. (<a href="../DSP/Audio/audio_loopback/DE1_SoC_Computer.v">top-level module</a>, <a href="../DSP/Audio/audio_loopback/DE1-SoC_Computer_15_audio_dsp.zip">ZIP of project</a>).<br />
-- A slightly reorgnized design separates the audio waveform generation and connections from the audio interface bus-master state machine. The DDS and loopback connections are separate from the generic bus read/write. (<a href="../DSP/Audio/audio_loopback/DE1_SoC_Computer (2).v">top-level module</a>) </p>
<p>-- <strong>Audio Filtering</strong><br />
The audio codec settings were changed in Qsys to enable 16-bit, 2's complement signals, to match the filters which had <a href="../../DE2/fpgaDSP.html">already been written for the DE2</a>. Changing the codec bit-width requires an edit (in Qsys) to both the <a href="../DSP/Audio/band_pass_16_bit/audio_config.PNG">AV_config dialog box</a>, then open the <a href="../DSP/Audio/band_pass_16_bit/audio_subsystem_config.PNG">Audio Subsystem</a> and edit that dialog box. The test filter was a 2-pole Butterworth, bandpass filter at 3000 to 6600 Hz, with a normalized freq 0.125 to 0.275, and Peak  at 0.2 which is 4800 Hz. Actual measured peak is 4740 Hz. The <a href="../DSP/Audio/band_pass_16_bit/IIR_verilog_header_test.m">matlab code</a> which writes the Verilog filter definition and converts to 2:16 fixed point format is also at the end of the top-level file. (<a href="../DSP/Audio/band_pass_16_bit/DE1_SoC_Computer.v">top-level module</a>, <a href="../DSP/Audio/band_pass_16_bit/verilog_audio_filter_16_bit.zip">ZIP of project</a>). The coefficients for a 2-pole butterworth never exceed +/-2.</p>
<p>-- <strong>Audio Filtering with decimated sample rate</strong><br />
Low frequency filters can be unstable with limited corfficient bits. A scheme to drop the sample rate to 8KHz (for voice) low pass filters the signal so that frequencies above 4 KHz are <a href="../DSP/Audio/Decimator_8k/decimator_freq_response.png">attenuated</a> about a factor of ten. Then the sample rate is lowered by taking every 8th sample out of the lowpass filter. This example compares two 300 Hz center frequency, Butterworth filters, with a design bandwidth of about 100 Hz. One is running at a sample rate of 48KHz, the other at 8KHz using input from the decimation filter output. (<a href="../DSP/Audio/Decimator_8k/DE1_SoC_Computer.v">top_level module</a>, <a href="../DSP/Audio/Decimator_8k/verilog_audio_decimated.zip">project ZIP</a>). The actual performance of the two seems very similar. Actual center frequency is 300+/-3 HZ. Bandwidths are similar, with half-amplitudes at about 225 Hz and 420 Hz. Filter headers were generated using a <a href="../DSP/Audio/Decimator_8k/IIR_verilog_header_test.m">matlab script</a> to translate filter coefficients from floating point to 2:16 fixed point. Another <a href="../DSP/Audio/Decimator_8k/IIR_verilog_header_decemator.m">script</a> was used to design the decimator filter.</p>
<p>-- <strong>Audio synthesis</strong><br />
  To convert 32-bit sound to 16-bit sound convert the references to fix2audio28(a) to fix2audio16(a) where <br />
  <span style="font-family: Consolas, 'Andale Mono', 'Lucida Console', 'Lucida Sans Typewriter', Monaco, 'Courier New', monospace">// shift fraction to 32-bit sound<br />
#define fix2audio28(a) (a&lt;&lt;4)<br />
// shift fraction to 16-bit sound<br />
#define fix2audio16(a) (a&gt;&gt;12)</span>  <br />
-- Drum: An audio peripherial driver code for the HPS (<a href="../DE1_soc_computer/Audio_video/media_brl4_7_audio_drum.c"><strong>audio code)</strong></a> was modified to support a finite difference drum scheme. The drum coded is a linear system with coefficients chosen so that cheap fixed-point shifts could be used to generate the 32-bit sound samples at 48Ksamples/sec. At -O3 optimization, I could just fit a 30x30 FDTD drum into the 20.8 microsecond systhesis time frame. If a more general drum tension is simulated with amplitude-dependent tension, then the size drops to about 24x24 grid points. See<a href="../../LABS/s2018/lab2_drum.html"> lab 2 (2018)</a> for references and details. Courant stability puts limits on rho in the code (speed of sound) to 0&lt;rho&lt;0.5. A lower rho means lower natural frequency.<br />
-- String (plucked): The <a href="../DSP/Audio/Synthesis/media_brl4_7_audio_string_rho.c">audio code</a> can also support a one-dimension finite difference simulation of a string to generate the 32-bit sound samples at 48Ksamples/sec.. Here the Courant stability limits 0&lt;rho&lt;1.0. The program asks for rho (0 to 1.0, initial amplitude (0 to 0.5), and the width of the pluck (0.5 to 30).
The string fundamental <span style="font-family: Consolas, 'Andale Mono', 'Lucida Console', 'Lucida Sans Typewriter', Monaco, 'Courier New', monospace">frequency = Fs*sqrt(rho)/(2*(string_size-2))</span>. The factor of 2 is there becuase we want to scale with the round-trip distance of the wave on the string. Subtracting 2 from the string size accounts for the zero end points. Square root of rho is proportional to the speed of wave propagation.<br />
-- String (plucked): A <a href="../DSP/Audio/Synthesis/media_brl4_8_audio_string_scale.c">variant of the string code</a> plays a scale using 32-bit sound samples at 48Ksamples/sec.. You choose the octave, pluck amplitude and pluck width. Octave zero starts at note C0. Octave four starts at C4. Pluck amplitude should be around 0.25, Pluck width varies from 0.1 to 100. the narrower the width, the more high frequency components are in the note. The initial condition is the product of a triangle wave and Gaussian to ensure that there are no discontinuities at the end points. <a href="../DSP/Audio/Synthesis/String_width10_octave_2.wav">Example</a> with octave 2, width 10. <a href="../DSP/Audio/Synthesis/String_width1_octave_2.wav">Example</a> with octave 2 width 1. <br />
-- String (bowed): An <a href="../DSP/Audio/Synthesis/media_brl4_9_audio_string_driven.c">approximation to bowing</a> uses a periodic drive instead of a initial condition <em>pluck</em>. The approximation I used is an impulse train with settable frequency, often the fundamental of the string, and some added noise. A more complete approximation would model the stick/slip of the bow on the string explicitly. An <a href="../DSP/Audio/Synthesis/String_octave2_bowed.wav">example</a> with octave=2, amp=0.0001, rise time=30000, fall time=5000, detune=1, impulse amp=1, noise amp=0.5.</p>
<p>&nbsp;</p>
<hr />
<p>-- Audio Goal (no verilog yet)<br />
  Build speech vocoder based on a <a href="../DSP/Audio/vocoder/filters.png">mel-spectrum analyser</a>. Output of the mel-spectrum is feed to a envelope filter with a time constant of about 16 mSec, then <a href="../DSP/Audio/vocoder/32_filters.wav">re-synthesized from sine waves</a>. (<a href="../DSP/Audio/vocoder/voice_bandpass_mel_bank_verilog.m">matlab code</a>).</p>
<hr />
<p>Copyright Cornell University 
  <!-- #BeginDate format:Am1 -->January 14, 2019<!-- #EndDate -->
</p>
<p>&nbsp;</p>
</body>
</html>
